<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>平安時代気象再現システム - 完全気圧操作版</title>
    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --accent-color: #536dfe;
            --low-pressure-color: #CC0000;
            --high-pressure-color: #0066CC;
            --warning-color: #ff6b6b;
            --success-color: #4caf50;
            --text-primary: #333;
            --text-secondary: #666;
            --bg-primary: #f5f7ff;
            --bg-secondary: #e8eaf6;
            --bg-card: #ffffff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic Pro', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 2000px;
            margin: 0 auto;
        }
        
        /* ヘッダー */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(26, 35, 126, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* メインコンテンツ */
        .main-grid {
            display: grid;
            grid-template-columns: 450px 1fr 400px;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 1600px) {
            .main-grid {
                grid-template-columns: 400px 1fr;
            }
        }
        
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* コントロールパネル */
        .control-panel {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            height: fit-content;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bg-secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title:first-child {
            margin-top: 0;
        }
        
        /* 基本設定 */
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        select, input[type="range"], input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(83, 109, 254, 0.1);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider-value {
            min-width: 50px;
            text-align: center;
            color: var(--accent-color);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        /* 気圧操作パネル */
        .pressure-edit-panel {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            height: fit-content;
        }
        
        .pressure-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .pressure-type-btn {
            padding: 15px;
            border: 2px solid var(--bg-secondary);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
        }
        
        .pressure-type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .pressure-type-btn.active {
            color: white;
        }
        
        .pressure-type-btn.high {
            border-color: var(--high-pressure-color);
        }
        
        .pressure-type-btn.high.active {
            background: var(--high-pressure-color);
        }
        
        .pressure-type-btn.low {
            border-color: var(--low-pressure-color);
        }
        
        .pressure-type-btn.low.active {
            background: var(--low-pressure-color);
        }
        
        /* 気圧詳細コントロール */
        .pressure-detail-controls {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .control-label {
            min-width: 100px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .control-input {
            flex: 1;
        }
        
        .pressure-visual {
            width: 100%;
            height: 120px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .pressure-visual.high {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 102, 204, 0.2));
            border: 2px solid var(--high-pressure-color);
        }
        
        .pressure-visual.low {
            background: linear-gradient(135deg, rgba(204, 0, 0, 0.1), rgba(204, 0, 0, 0.2));
            border: 2px solid var(--low-pressure-color);
        }
        
        .pressure-visual-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .pressure-visual-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        /* 気圧リスト */
        .pressure-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid var(--bg-secondary);
            border-radius: 10px;
            padding: 10px;
        }
        
        .pressure-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .pressure-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .pressure-item.selected {
            border-color: var(--accent-color);
            background: rgba(83, 109, 254, 0.05);
        }
        
        .pressure-item.high {
            border-left: 4px solid var(--high-pressure-color);
        }
        
        .pressure-item.low {
            border-left: 4px solid var(--low-pressure-color);
        }
        
        .pressure-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pressure-item-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .pressure-item.high .pressure-item-icon {
            background: var(--high-pressure-color);
        }
        
        .pressure-item.low .pressure-item-icon {
            background: var(--low-pressure-color);
        }
        
        .pressure-item-details {
            display: flex;
            flex-direction: column;
        }
        
        .pressure-item-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .pressure-item-stats {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .pressure-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .pressure-action-btn {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .pressure-action-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.1);
        }
        
        /* マップコンテナ */
        .map-container {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            min-height: 800px;
        }
        
        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bg-secondary);
        }
        
        .era-display {
            font-size: 1.8rem;
            color: var(--primary-color);
            font-weight: 700;
        }
        
        #weatherCanvas {
            width: 100%;
            height: 700px;
            border-radius: 10px;
            border: 2px solid var(--bg-secondary);
            background: #e8f4f8;
            display: block;
            cursor: crosshair;
            touch-action: none;
        }
        
        /* 操作ヒント */
        .operation-hint {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .hint-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .hint-list {
            list-style: none;
            padding-left: 5px;
        }
        
        .hint-list li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        
        .hint-list li:before {
            content: "•";
            color: var(--accent-color);
            font-weight: bold;
            position: absolute;
            left: 0;
        }
        
        /* ボタン */
        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), #3d5afe);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(83, 109, 254, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #43a047);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #ff5252);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.3);
        }
        
        /* 凡例 */
        .legend {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .main-grid {
                gap: 15px;
            }
            
            .pressure-type-selector {
                grid-template-columns: 1fr;
            }
            
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-label {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="header">
            <h1>平安時代気象再現システム</h1>
            <p class="subtitle">完全気圧操作 × 物理モデル × リアルタイム編集</p>
        </header>
        
        <!-- メインコンテンツ -->
        <div class="main-grid">
            <!-- 左側: 基本設定パネル -->
            <div class="control-panel">
                <!-- 時代選択 -->
                <div class="section-title">
                    <i class="fas fa-history"></i>
                    時代設定
                </div>
                
                <div class="input-group">
                    <label for="yearSelect">西暦指定 (794-1185)</label>
                    <div class="slider-container">
                        <input type="range" id="yearSelect" min="794" max="1185" value="1000" step="1">
                        <span class="slider-value" id="yearValue">1000年</span>
                    </div>
                </div>
                
                <!-- 気候パラメータ -->
                <div class="section-title">
                    <i class="fas fa-sliders-h"></i>
                    気候パラメータ
                </div>
                
                <div class="input-group">
                    <label for="temperature">平均気温: <span id="tempValue">24.5</span>°C</label>
                    <input type="range" id="temperature" min="20" max="30" value="24.5" step="0.1">
                </div>
                
                <div class="input-group">
                    <label for="humidity">湿度: <span id="humidityValue">60</span>%</label>
                    <input type="range" id="humidity" min="30" max="100" value="60" step="1">
                </div>
                
                <div class="input-group">
                    <label for="enso">ENSO指数: <span id="ensoValue">0.0</span></label>
                    <input type="range" id="enso" min="-2" max="2" value="0" step="0.1">
                </div>
                
                <!-- 操作ボタン -->
                <div class="section-title">
                    <i class="fas fa-cogs"></i>
                    システム操作
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" id="addPressureBtn">
                        <i class="fas fa-plus-circle"></i>
                        気圧追加
                    </button>
                    <button class="btn btn-primary" id="generateWindBtn">
                        <i class="fas fa-wind"></i>
                        風場生成
                    </button>
                    <button class="btn btn-primary" id="animateBtn">
                        <i class="fas fa-play"></i>
                        アニメーション
                    </button>
                </div>
                
                <!-- 操作ヒント -->
                <div class="operation-hint">
                    <div class="hint-title">
                        <i class="fas fa-lightbulb"></i>
                        操作ガイド
                    </div>
                    <ul class="hint-list">
                        <li><strong>気圧追加</strong>：地図をクリックして気圧中心を設置</li>
                        <li><strong>ドラッグ</strong>：気圧中心を移動</li>
                        <li><strong>ダブルクリック</strong>：気圧を選択して編集</li>
                        <li><strong>Deleteキー</strong>：選択中の気圧を削除</li>
                    </ul>
                </div>
            </div>
            
            <!-- 中央: 地図表示 -->
            <div class="map-container">
                <div class="map-header">
                    <div class="era-display" id="eraDisplay">平安中期 (西暦1000年)</div>
                    <div>
                        <div id="weatherDisplay">操作モード: 気圧配置</div>
                        <div id="locationDisplay">選択: なし</div>
                    </div>
                </div>
                
                <canvas id="weatherCanvas"></canvas>
                
                <!-- 凡例 -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #0066CC;"></div>
                        <span>高気圧 (ドラッグ可)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #CC0000;"></div>
                        <span>低気圧 (ドラッグ可)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #009900;"></div>
                        <span>等圧線</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF9900;"></div>
                        <span>風向・風速</span>
                    </div>
                </div>
            </div>
            
            <!-- 右側: 気圧編集パネル -->
            <div class="pressure-edit-panel">
                <!-- 気圧タイプ選択 -->
                <div class="section-title">
                    <i class="fas fa-edit"></i>
                    気圧編集
                </div>
                
                <div class="pressure-type-selector">
                    <button class="pressure-type-btn high active" data-type="high">
                        <i class="fas fa-arrow-up"></i>
                        高気圧
                    </button>
                    <button class="pressure-type-btn low" data-type="low">
                        <i class="fas fa-arrow-down"></i>
                        低気圧
                    </button>
                </div>
                
                <!-- 気圧詳細設定 -->
                <div class="pressure-detail-controls">
                    <div class="input-group">
                        <label for="pressureName">気圧名称</label>
                        <input type="text" id="pressureName" value="新規高気圧" placeholder="気圧の名前を入力">
                    </div>
                    
                    <div class="control-row">
                        <span class="control-label">気圧値</span>
                        <div class="control-input">
                            <input type="range" id="pressureValue" min="980" max="1040" value="1020" step="1">
                            <div class="slider-value" id="pressureValueDisplay">1020 hPa</div>
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <span class="control-label">大きさ</span>
                        <div class="control-input">
                            <input type="range" id="pressureSize" min="100" max="500" value="300" step="10">
                            <div class="slider-value" id="pressureSizeDisplay">300 km</div>
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <span class="control-label">強度</span>
                        <div class="control-input">
                            <input type="range" id="pressureStrength" min="0.5" max="3.0" value="1.5" step="0.1">
                            <div class="slider-value" id="pressureStrengthDisplay">1.5</div>
                        </div>
                    </div>
                    
                    <!-- 位置情報 -->
                    <div class="input-group">
                        <label for="pressurePosition">位置情報</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="number" id="pressureLat" value="35.0" step="0.1" placeholder="緯度">
                            <input type="number" id="pressureLon" value="135.0" step="0.1" placeholder="経度">
                        </div>
                    </div>
                    
                    <!-- 気圧ビジュアル -->
                    <div class="pressure-visual high" id="pressureVisual">
                        <div class="pressure-visual-icon" id="pressureIcon">高</div>
                        <div class="pressure-visual-value" id="pressureVisualValue">1020 hPa</div>
                    </div>
                </div>
                
                <!-- 操作ボタン -->
                <div class="button-group">
                    <button class="btn btn-success" id="applyPressureBtn">
                        <i class="fas fa-check"></i>
                        適用
                    </button>
                    <button class="btn btn-warning" id="deletePressureBtn">
                        <i class="fas fa-trash"></i>
                        削除
                    </button>
                    <button class="btn btn-primary" id="clearAllBtn">
                        <i class="fas fa-eraser"></i>
                        全消去
                    </button>
                </div>
                
                <!-- 気圧リスト -->
                <div class="section-title">
                    <i class="fas fa-list"></i>
                    気圧システム一覧
                </div>
                
                <div class="pressure-list" id="pressureList">
                    <!-- 気圧アイテムがここに動的に追加されます -->
                </div>
            </div>
        </div>
    </div>

    <!-- スクリプト -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        // ==================== 1. 気圧システム管理クラス ====================
        class PressureSystemManager {
            constructor() {
                this.systems = [];
                this.selectedSystemId = null;
                this.nextId = 1;
                this.draggingSystemId = null;
                this.dragStartPos = null;
            }
            
            // 新しい気圧システムを追加
            addSystem(type, lat, lon, name = null) {
                const id = this.nextId++;
                const defaultValues = type === 'high' ? {
                    name: name || `高気圧${id}`,
                    type: 'high',
                    pressure: 1020 + Math.random() * 10,
                    lat: lat,
                    lon: lon,
                    size: 300,
                    strength: 1.5,
                    movement: { speed: 10, direction: 240 }
                } : {
                    name: name || `低気圧${id}`,
                    type: 'low',
                    pressure: 1000 - Math.random() * 10,
                    lat: lat,
                    lon: lon,
                    size: 250,
                    strength: 1.8,
                    movement: { speed: 25, direction: 60 }
                };
                
                const system = {
                    id: id,
                    ...defaultValues,
                    timestamp: new Date().toISOString()
                };
                
                this.systems.push(system);
                this.selectedSystemId = id;
                this.updatePressureList();
                
                return system;
            }
            
            // 気圧システムを更新
            updateSystem(id, updates) {
                const index = this.systems.findIndex(s => s.id === id);
                if (index !== -1) {
                    this.systems[index] = { ...this.systems[index], ...updates };
                    this.updatePressureList();
                    return true;
                }
                return false;
            }
            
            // 気圧システムを削除
            removeSystem(id) {
                const index = this.systems.findIndex(s => s.id === id);
                if (index !== -1) {
                    this.systems.splice(index, 1);
                    if (this.selectedSystemId === id) {
                        this.selectedSystemId = null;
                    }
                    this.updatePressureList();
                    return true;
                }
                return false;
            }
            
            // 全ての気圧システムを削除
            clearAll() {
                this.systems = [];
                this.selectedSystemId = null;
                this.updatePressureList();
            }
            
            // 気圧システムを選択
            selectSystem(id) {
                this.selectedSystemId = id;
                this.updatePressureList();
                
                const system = this.getSystem(id);
                if (system) {
                    this.updateEditPanel(system);
                }
                
                return system;
            }
            
            // 気圧システムを取得
            getSystem(id) {
                return this.systems.find(s => s.id === id);
            }
            
            // 気圧リストのUIを更新
            updatePressureList() {
                const listContainer = document.getElementById('pressureList');
                listContainer.innerHTML = '';
                
                this.systems.forEach(system => {
                    const isSelected = system.id === this.selectedSystemId;
                    
                    const item = document.createElement('div');
                    item.className = `pressure-item ${system.type} ${isSelected ? 'selected' : ''}`;
                    item.dataset.id = system.id;
                    
                    item.innerHTML = `
                        <div class="pressure-item-info">
                            <div class="pressure-item-icon">${system.type === 'high' ? '高' : '低'}</div>
                            <div class="pressure-item-details">
                                <div class="pressure-item-name">${system.name}</div>
                                <div class="pressure-item-stats">
                                    ${system.pressure.toFixed(1)} hPa • 
                                    大きさ: ${system.size} km •
                                    ${system.lat.toFixed(2)}°N, ${system.lon.toFixed(2)}°E
                                </div>
                            </div>
                        </div>
                        <div class="pressure-item-actions">
                            <button class="pressure-action-btn edit-btn" title="編集">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="pressure-action-btn delete-btn" title="削除">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    // クリックで選択
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.pressure-action-btn')) {
                            this.selectSystem(system.id);
                        }
                    });
                    
                    // 編集ボタン
                    item.querySelector('.edit-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.selectSystem(system.id);
                    });
                    
                    // 削除ボタン
                    item.querySelector('.delete-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.removeSystem(system.id);
                        renderWeatherMap();
                    });
                    
                    listContainer.appendChild(item);
                });
            }
            
            // 編集パネルを更新
            updateEditPanel(system) {
                document.getElementById('pressureName').value = system.name;
                document.getElementById('pressureValue').value = system.pressure;
                document.getElementById('pressureValueDisplay').textContent = `${system.pressure.toFixed(0)} hPa`;
                document.getElementById('pressureSize').value = system.size;
                document.getElementById('pressureSizeDisplay').textContent = `${system.size} km`;
                document.getElementById('pressureStrength').value = system.strength;
                document.getElementById('pressureStrengthDisplay').textContent = system.strength.toFixed(1);
                document.getElementById('pressureLat').value = system.lat.toFixed(2);
                document.getElementById('pressureLon').value = system.lon.toFixed(2);
                
                // タイプボタンの更新
                document.querySelectorAll('.pressure-type-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.pressure-type-btn.${system.type}`).classList.add('active');
                
                // ビジュアルの更新
                const visual = document.getElementById('pressureVisual');
                visual.className = `pressure-visual ${system.type}`;
                visual.querySelector('#pressureIcon').textContent = system.type === 'high' ? '高' : '低';
                visual.querySelector('#pressureVisualValue').textContent = `${system.pressure.toFixed(0)} hPa`;
            }
            
            // 気圧システムを移動
            moveSystem(id, newLat, newLon) {
                const system = this.getSystem(id);
                if (system) {
                    system.lat = newLat;
                    system.lon = newLon;
                    this.updatePressureList();
                    return true;
                }
                return false;
            }
            
            // ドラッグ開始
            startDrag(systemId, startX, startY) {
                const system = this.getSystem(systemId);
                if (system) {
                    this.draggingSystemId = systemId;
                    this.dragStartPos = { lat: system.lat, lon: system.lon, x: startX, y: startY };
                    return true;
                }
                return false;
            }
            
            // ドラッグ更新
            updateDrag(mouseX, mouseY) {
                if (!this.draggingSystemId || !this.dragStartPos) return;
                
                const system = this.getSystem(this.draggingSystemId);
                if (!system) return;
                
                // 座標変換（簡易版）
                const latDelta = (mouseY - this.dragStartPos.y) * -0.1;
                const lonDelta = (mouseX - this.dragStartPos.x) * 0.1;
                
                system.lat = Math.max(30, Math.min(45, this.dragStartPos.lat + latDelta));
                system.lon = Math.max(125, Math.min(145, this.dragStartPos.lon + lonDelta));
                
                this.updateEditPanel(system);
                return system;
            }
            
            // ドラッグ終了
            endDrag() {
                this.draggingSystemId = null;
                this.dragStartPos = null;
            }
            
            // 等圧線を生成
            generateIsobars() {
                const isobars = [];
                const interval = 4; // 4hPa間隔
                
                this.systems.forEach(system => {
                    const type = system.type;
                    const basePressure = system.pressure;
                    const radius = system.size;
                    
                    for (let p = Math.floor(basePressure); 
                         type === 'high' ? p >= Math.floor(basePressure) - 20 : p <= Math.floor(basePressure) + 20; 
                         type === 'high' ? p -= interval : p += interval) {
                        
                        if (p % interval === 0) {
                            const pressureDiff = Math.abs(basePressure - p);
                            const isobarRadius = radius * (1 + pressureDiff / 5);
                            
                            isobars.push({
                                pressure: p,
                                center: { lat: system.lat, lon: system.lon },
                                radius: isobarRadius,
                                type: type
                            });
                        }
                    }
                });
                
                return isobars;
            }
            
            // 風場を計算
            calculateWindField() {
                const windField = [];
                const gridSize = 2; // グリッド間隔（度）
                
                for (let lat = 30; lat <= 45; lat += gridSize) {
                    for (let lon = 125; lon <= 145; lon += gridSize) {
                        let pressureGradientX = 0;
                        let pressureGradientY = 0;
                        
                        // 各気圧システムからの寄与を計算
                        this.systems.forEach(system => {
                            const dx = (lon - system.lon) * 111.32 * Math.cos(lat * Math.PI / 180);
                            const dy = (lat - system.lat) * 111.32;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < system.size) {
                                const influence = (system.size - distance) / system.size;
                                const gradient = system.strength * influence;
                                
                                if (system.type === 'high') {
                                    pressureGradientX -= gradient * (lon - system.lon) / distance;
                                    pressureGradientY -= gradient * (lat - system.lat) / distance;
                                } else {
                                    pressureGradientX += gradient * (lon - system.lon) / distance;
                                    pressureGradientY += gradient * (lat - system.lat) / distance;
                                }
                            }
                        });
                        
                        // 地衡風の計算（簡易版）
                        if (Math.abs(pressureGradientX) > 0.001 || Math.abs(pressureGradientY) > 0.001) {
                            const gradient = Math.sqrt(pressureGradientX * pressureGradientX + pressureGradientY * pressureGradientY);
                            const coriolis = 2 * 7.2921e-5 * Math.sin(lat * Math.PI / 180);
                            const windSpeed = gradient / (1.225 * Math.abs(coriolis) + 0.0001);
                            
                            // 風向（気圧傾度力の90度右）
                            let direction = Math.atan2(pressureGradientY, pressureGradientX) * 180 / Math.PI + 90;
                            if (direction < 0) direction += 360;
                            if (direction >= 360) direction -= 360;
                            
                            windField.push({
                                lat: lat,
                                lon: lon,
                                speed: Math.min(windSpeed, 50), // 最大50m/s
                                direction: direction
                            });
                        }
                    }
                }
                
                return windField;
            }
        }
        
        // ==================== 2. 天気図描画クラス ====================
        class WeatherMapRenderer {
            constructor(canvasId, pressureManager) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.pressureManager = pressureManager;
                
                this.width = this.canvas.width = this.canvas.parentElement.clientWidth;
                this.height = this.canvas.height = 700;
                
                this.isAnimating = false;
                this.animationId = null;
                this.frameCount = 0;
                
                // イベントリスナーの設定
                this.setupEventListeners();
                
                // 初期描画
                this.drawBackground();
            }
            
            setupEventListeners() {
                // キャンバスクリックで気圧追加
                this.canvas.addEventListener('click', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const latLon = this.canvasToLatLon(x, y);
                    
                    // 気圧タイプを取得
                    const pressureType = document.querySelector('.pressure-type-btn.active').dataset.type;
                    
                    // 新しい気圧を追加
                    this.pressureManager.addSystem(pressureType, latLon.lat, latLon.lon);
                    
                    // 再描画
                    this.render();
                });
                
                // ダブルクリックで気圧選択
                this.canvas.addEventListener('dblclick', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const clickedSystem = this.findSystemAtPosition(x, y);
                    if (clickedSystem) {
                        this.pressureManager.selectSystem(clickedSystem.id);
                    }
                });
                
                // ドラッグ開始
                this.canvas.addEventListener('mousedown', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const clickedSystem = this.findSystemAtPosition(x, y);
                    if (clickedSystem) {
                        this.pressureManager.startDrag(clickedSystem.id, x, y);
                        this.canvas.style.cursor = 'grabbing';
                    }
                });
                
                // ドラッグ中
                this.canvas.addEventListener('mousemove', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    if (this.pressureManager.draggingSystemId) {
                        this.pressureManager.updateDrag(x, y);
                        this.render();
                    } else {
                        // カーソル変更
                        const system = this.findSystemAtPosition(x, y);
                        this.canvas.style.cursor = system ? 'grab' : 'crosshair';
                    }
                });
                
                // ドラッグ終了
                this.canvas.addEventListener('mouseup', () => {
                    if (this.pressureManager.draggingSystemId) {
                        this.pressureManager.endDrag();
                        this.canvas.style.cursor = 'crosshair';
                    }
                });
                
                // マウスがキャンバスから離れたとき
                this.canvas.addEventListener('mouseleave', () => {
                    if (this.pressureManager.draggingSystemId) {
                        this.pressureManager.endDrag();
                        this.canvas.style.cursor = 'crosshair';
                    }
                });
                
                // Deleteキーで選択中の気圧を削除
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Delete' && this.pressureManager.selectedSystemId) {
                        this.pressureManager.removeSystem(this.pressureManager.selectedSystemId);
                        this.render();
                    }
                });
                
                // ウィンドウリサイズ
                window.addEventListener('resize', () => {
                    this.width = this.canvas.width = this.canvas.parentElement.clientWidth;
                    this.height = this.canvas.height = 700;
                    this.render();
                });
            }
            
            canvasToLatLon(x, y) {
                // キャンバス座標を緯度経度に変換
                const lat = 45 - (y / this.height) * (45 - 30);
                const lon = 125 + (x / this.width) * (145 - 125);
                return { lat: Math.max(30, Math.min(45, lat)), lon: Math.max(125, Math.min(145, lon)) };
            }
            
            latLonToCanvas(lat, lon) {
                // 緯度経度をキャンバス座標に変換
                const x = ((lon - 125) / (145 - 125)) * this.width;
                const y = this.height - ((lat - 30) / (45 - 30)) * this.height;
                return { x, y };
            }
            
            findSystemAtPosition(x, y) {
                const latLon = this.canvasToLatLon(x, y);
                
                for (const system of this.pressureManager.systems) {
                    const pos = this.latLonToCanvas(system.lat, system.lon);
                    const distance = Math.sqrt(Math.pow(pos.x - x, 2) + Math.pow(pos.y - y, 2));
                    
                    // クリック範囲（半径15px）
                    if (distance < 15) {
                        return system;
                    }
                }
                return null;
            }
            
            drawBackground() {
                // 背景グラデーション
                const gradient = this.ctx.createLinearGradient(0, 0, this.width, this.height);
                gradient.addColorStop(0, '#e8f4f8');
                gradient.addColorStop(1, '#cce7ff');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.width, this.height);
                
                // グリッド線
                this.ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                this.ctx.lineWidth = 1;
                
                // 経度線
                for (let lon = 125; lon <= 145; lon += 5) {
                    const pos = this.latLonToCanvas(30, lon);
                    this.ctx.beginPath();
                    this.ctx.moveTo(pos.x, 0);
                    this.ctx.lineTo(pos.x, this.height);
                    this.ctx.stroke();
                    
                    // ラベル
                    this.ctx.fillStyle = '#333';
                    this.ctx.font = '12px Arial';
                    this.ctx.fillText(`${lon}°E`, pos.x + 5, 20);
                }
                
                // 緯度線
                for (let lat = 30; lat <= 45; lat += 5) {
                    const pos = this.latLonToCanvas(lat, 125);
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, pos.y);
                    this.ctx.lineTo(this.width, pos.y);
                    this.ctx.stroke();
                    
                    // ラベル
                    this.ctx.fillText(`${lat}°N`, 10, pos.y - 5);
                }
                
                // 日本列島の簡易シルエット
                this.drawJapanSilhouette();
            }
            
            drawJapanSilhouette() {
                this.ctx.fillStyle = 'rgba(144, 238, 144, 0.4)';
                this.ctx.strokeStyle = '#2E8B57';
                this.ctx.lineWidth = 2;
                
                // 本州
                this.ctx.beginPath();
                const points = [
                    this.latLonToCanvas(41.5, 140.0),
                    this.latLonToCanvas(40.5, 141.5),
                    this.latLonToCanvas(39.0, 141.5),
                    this.latLonToCanvas(37.0, 140.5),
                    this.latLonToCanvas(35.0, 139.0),
                    this.latLonToCanvas(34.0, 136.0),
                    this.latLonToCanvas(33.0, 132.0),
                    this.latLonToCanvas(34.5, 131.0),
                    this.latLonToCanvas(35.5, 133.0),
                    this.latLonToCanvas(36.5, 135.0),
                    this.latLonToCanvas(38.0, 137.0),
                    this.latLonToCanvas(39.5, 139.5),
                    this.latLonToCanvas(41.5, 140.0)
                ];
                
                this.ctx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    this.ctx.lineTo(points[i].x, points[i].y);
                }
                this.ctx.closePath();
                this.ctx.fill();
                this.ctx.stroke();
            }
            
            drawIsobars(isobars) {
                isobars.forEach(isobar => {
                    const pos = this.latLonToCanvas(isobar.center.lat, isobar.center.lon);
                    const radius = isobar.radius * (this.width / (145 - 125)) / 111.32;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
                    this.ctx.strokeStyle = isobar.type === 'high' ? 
                        'rgba(0, 102, 204, 0.7)' : 'rgba(204, 0, 0, 0.7)';
                    this.ctx.lineWidth = 1.5;
                    this.ctx.setLineDash([5, 3]);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                });
            }
            
            drawPressureCenters(systems) {
                systems.forEach(system => {
                    const pos = this.latLonToCanvas(system.lat, system.lon);
                    const isSelected = system.id === this.pressureManager.selectedSystemId;
                    const isDragging = system.id === this.pressureManager.draggingSystemId;
                    
                    // サイズに基づく円
                    const sizeRadius = system.size * (this.width / (145 - 125)) / 111.32 / 5;
                    this.ctx.beginPath();
                    this.ctx.arc(pos.x, pos.y, sizeRadius, 0, Math.PI * 2);
                    this.ctx.fillStyle = system.type === 'high' ? 
                        'rgba(0, 102, 204, 0.1)' : 'rgba(204, 0, 0, 0.1)';
                    this.ctx.fill();
                    this.ctx.strokeStyle = system.type === 'high' ? 
                        'rgba(0, 102, 204, 0.3)' : 'rgba(204, 0, 0, 0.3)';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                    
                    // 中心点
                    this.ctx.beginPath();
                    this.ctx.arc(pos.x, pos.y, isSelected ? 16 : 12, 0, Math.PI * 2);
                    this.ctx.fillStyle = system.type === 'high' ? '#0066CC' : '#CC0000';
                    this.ctx.fill();
                    this.ctx.strokeStyle = isSelected ? '#FFD700' : '#FFFFFF';
                    this.ctx.lineWidth = isSelected ? 4 : 3;
                    this.ctx.stroke();
                    
                    // ドラッグ中の場合はパルス効果
                    if (isDragging) {
                        this.ctx.beginPath();
                        this.ctx.arc(pos.x, pos.y, 20 + Math.sin(this.frameCount * 0.1) * 5, 0, Math.PI * 2);
                        this.ctx.strokeStyle = system.type === 'high' ? 
                            'rgba(0, 102, 204, 0.5)' : 'rgba(204, 0, 0, 0.5)';
                        this.ctx.lineWidth = 2;
                        this.ctx.stroke();
                    }
                    
                    // 「高」「低」ラベル
                    this.ctx.fillStyle = '#FFFFFF';
                    this.ctx.font = isSelected ? 'bold 14px Arial' : 'bold 12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(system.type === 'high' ? '高' : '低', pos.x, pos.y);
                    
                    // 気圧値
                    this.ctx.fillStyle = system.type === 'high' ? '#0066CC' : '#CC0000';
                    this.ctx.font = 'bold 14px Arial';
                    this.ctx.fillText(`${system.pressure.toFixed(0)} hPa`, pos.x, pos.y - 25);
                    
                    // 名前（選択時のみ）
                    if (isSelected) {
                        this.ctx.fillStyle = '#333';
                        this.ctx.font = '12px Arial';
                        this.ctx.fillText(system.name, pos.x, pos.y + 25);
                    }
                });
            }
            
            drawWindField(windField) {
                windField.forEach(wind => {
                    const pos = this.latLonToCanvas(wind.lat, wind.lon);
                    
                    // 風速が小さい場合は描画しない
                    if (wind.speed < 1) return;
                    
                    const length = Math.min(wind.speed * 2, 40);
                    const angle = (wind.direction - 90) * Math.PI / 180;
                    
                    // 矢印の線
                    this.ctx.beginPath();
                    this.ctx.moveTo(pos.x, pos.y);
                    this.ctx.lineTo(
                        pos.x + length * Math.cos(angle),
                        pos.y + length * Math.sin(angle)
                    );
                    this.ctx.strokeStyle = '#333';
                    this.ctx.lineWidth = Math.min(wind.speed / 10, 3);
                    this.ctx.stroke();
                    
                    // 矢印の頭
                    this.ctx.beginPath();
                    this.ctx.moveTo(
                        pos.x + length * Math.cos(angle),
                        pos.y + length * Math.sin(angle)
                    );
                    this.ctx.lineTo(
                        pos.x + (length - 8) * Math.cos(angle - Math.PI/6),
                        pos.y + (length - 8) * Math.sin(angle - Math.PI/6)
                    );
                    this.ctx.lineTo(
                        pos.x + (length - 8) * Math.cos(angle + Math.PI/6),
                        pos.y + (length - 8) * Math.sin(angle + Math.PI/6)
                    );
                    this.ctx.closePath();
                    this.ctx.fillStyle = '#333';
                    this.ctx.fill();
                });
            }
            
            render() {
                // キャンバスをクリア
                this.ctx.clearRect(0, 0, this.width, this.height);
                
                // 背景を描画
                this.drawBackground();
                
                // 気圧システムがなければここで終了
                if (this.pressureManager.systems.length === 0) {
                    this.ctx.fillStyle = '#666';
                    this.ctx.font = '20px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('地図をクリックして気圧システムを追加してください', 
                                     this.width/2, this.height/2);
                    return;
                }
                
                // 等圧線を描画
                const isobars = this.pressureManager.generateIsobars();
                this.drawIsobars(isobars);
                
                // 風場を描画
                const windField = this.pressureManager.calculateWindField();
                this.drawWindField(windField);
                
                // 気圧中心を描画
                this.drawPressureCenters(this.pressureManager.systems);
                
                // タイトルと情報
                this.ctx.fillStyle = '#1a237e';
                this.ctx.font = 'bold 24px Arial';
                this.ctx.textAlign = 'left';
                this.ctx.fillText('平安時代天気図 - 気圧操作モード', 20, 40);
                
                const selectedCount = this.pressureManager.systems.length;
                this.ctx.font = '14px Arial';
                this.ctx.fillStyle = '#666';
                this.ctx.fillText(`気圧システム: ${selectedCount}個`, 20, 70);
                
                if (this.pressureManager.selectedSystemId) {
                    const system = this.pressureManager.getSystem(this.pressureManager.selectedSystemId);
                    this.ctx.fillText(`選択中: ${system.name} (${system.type === 'high' ? '高気圧' : '低気圧'})`, 20, 90);
                }
                
                // 現在時刻
                const now = new Date();
                this.ctx.textAlign = 'right';
                this.ctx.fillText(`更新: ${now.toLocaleTimeString()}`, this.width - 20, this.height - 20);
                
                // フレームカウント更新
                this.frameCount++;
            }
            
            startAnimation() {
                if (this.isAnimating) return;
                
                this.isAnimating = true;
                
                const animate = () => {
                    if (!this.isAnimating) return;
                    
                    // 気圧システムを少しずつ移動
                    this.pressureManager.systems.forEach(system => {
                        const movement = system.movement;
                        const latDelta = movement.speed * Math.sin(movement.direction * Math.PI / 180) / 111.32 / 3600;
                        const lonDelta = movement.speed * Math.cos(movement.direction * Math.PI / 180) / (111.32 * Math.cos(system.lat * Math.PI / 180)) / 3600;
                        
                        system.lat += latDelta * 10; // 10倍速
                        system.lon += lonDelta * 10;
                        
                        // 境界チェック
                        if (system.lat < 30 || system.lat > 45) {
                            movement.direction = 180 - movement.direction;
                        }
                        if (system.lon < 125 || system.lon > 145) {
                            movement.direction = 360 - movement.direction;
                        }
                        
                        system.lat = Math.max(30, Math.min(45, system.lat));
                        system.lon = Math.max(125, Math.min(145, system.lon));
                    });
                    
                    this.render();
                    this.animationId = requestAnimationFrame(animate);
                };
                
                animate();
            }
            
            stopAnimation() {
                this.isAnimating = false;
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
            }
        }
        
        // ==================== 3. アプリケーション初期化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            // 気圧マネージャーの初期化
            const pressureManager = new PressureSystemManager();
            
            // 天気図レンダラーの初期化
            const mapRenderer = new WeatherMapRenderer('weatherCanvas', pressureManager);
            
            // UI要素の取得
            const yearSelect = document.getElementById('yearSelect');
            const yearValue = document.getElementById('yearValue');
            const tempSlider = document.getElementById('temperature');
            const tempValue = document.getElementById('tempValue');
            const humiditySlider = document.getElementById('humidity');
            const humidityValue = document.getElementById('humidityValue');
            const ensoSlider = document.getElementById('enso');
            const ensoValue = document.getElementById('ensoValue');
            const eraDisplay = document.getElementById('eraDisplay');
            
            // 気圧タイプ選択ボタン
            document.querySelectorAll('.pressure-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.pressure-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // ビジュアルの更新
                    const type = this.dataset.type;
                    const visual = document.getElementById('pressureVisual');
                    visual.className = `pressure-visual ${type}`;
                    visual.querySelector('#pressureIcon').textContent = type === 'high' ? '高' : '低';
                    
                    // デフォルト値の設定
                    if (type === 'high') {
                        document.getElementById('pressureValue').value = 1020;
                        document.getElementById('pressureValueDisplay').textContent = '1020 hPa';
                        document.getElementById('pressureVisualValue').textContent = '1020 hPa';
                    } else {
                        document.getElementById('pressureValue').value = 1000;
                        document.getElementById('pressureValueDisplay').textContent = '1000 hPa';
                        document.getElementById('pressureVisualValue').textContent = '1000 hPa';
                    }
                });
            });
            
            // 気圧値スライダー
            document.getElementById('pressureValue').addEventListener('input', function() {
                const value = parseInt(this.value);
                document.getElementById('pressureValueDisplay').textContent = `${value} hPa`;
                document.getElementById('pressureVisualValue').textContent = `${value} hPa`;
            });
            
            // 気圧サイズスライダー
            document.getElementById('pressureSize').addEventListener('input', function() {
                const value = parseInt(this.value);
                document.getElementById('pressureSizeDisplay').textContent = `${value} km`;
            });
            
            // 気圧強度スライダー
            document.getElementById('pressureStrength').addEventListener('input', function() {
                const value = parseFloat(this.value);
                document.getElementById('pressureStrengthDisplay').textContent = value.toFixed(1);
            });
            
            // 位置情報入力
            document.getElementById('pressureLat').addEventListener('change', function() {
                const lat = parseFloat(this.value);
                this.value = Math.max(30, Math.min(45, lat)).toFixed(2);
            });
            
            document.getElementById('pressureLon').addEventListener('change', function() {
                const lon = parseFloat(this.value);
                this.value = Math.max(125, Math.min(145, lon)).toFixed(2);
            });
            
            // 気圧設定を適用
            document.getElementById('applyPressureBtn').addEventListener('click', function() {
                if (pressureManager.selectedSystemId) {
                    const updates = {
                        name: document.getElementById('pressureName').value,
                        type: document.querySelector('.pressure-type-btn.active').dataset.type,
                        pressure: parseFloat(document.getElementById('pressureValue').value),
                        size: parseFloat(document.getElementById('pressureSize').value),
                        strength: parseFloat(document.getElementById('pressureStrength').value),
                        lat: parseFloat(document.getElementById('pressureLat').value),
                        lon: parseFloat(document.getElementById('pressureLon').value)
                    };
                    
                    pressureManager.updateSystem(pressureManager.selectedSystemId, updates);
                    mapRenderer.render();
                } else {
                    alert('編集する気圧システムを選択してください');
                }
            });
            
            // 気圧を削除
            document.getElementById('deletePressureBtn').addEventListener('click', function() {
                if (pressureManager.selectedSystemId) {
                    if (confirm('選択中の気圧システムを削除しますか？')) {
                        pressureManager.removeSystem(pressureManager.selectedSystemId);
                        mapRenderer.render();
                    }
                } else {
                    alert('削除する気圧システムを選択してください');
                }
            });
            
            // 全ての気圧を削除
            document.getElementById('clearAllBtn').addEventListener('click', function() {
                if (pressureManager.systems.length > 0) {
                    if (confirm('全ての気圧システムを削除しますか？')) {
                        pressureManager.clearAll();
                        mapRenderer.render();
                    }
                } else {
                    alert('削除する気圧システムがありません');
                }
            });
            
            // 気圧を追加
            document.getElementById('addPressureBtn').addEventListener('click', function() {
                const type = document.querySelector('.pressure-type-btn.active').dataset.type;
                const lat = 35.0 + (Math.random() - 0.5) * 5;
                const lon = 135.0 + (Math.random() - 0.5) * 5;
                const name = document.getElementById('pressureName').value || 
                             (type === 'high' ? '新規高気圧' : '新規低気圧');
                
                pressureManager.addSystem(type, lat, lon, name);
                mapRenderer.render();
            });
            
            // 風場を生成
            document.getElementById('generateWindBtn').addEventListener('click', function() {
                mapRenderer.render();
                alert('気圧配置に基づいて風場を再計算しました');
            });
            
            // アニメーション開始/停止
            const animateBtn = document.getElementById('animateBtn');
            let isAnimating = false;
            
            animateBtn.addEventListener('click', function() {
                if (!isAnimating) {
                    mapRenderer.startAnimation();
                    this.innerHTML = '<i class="fas fa-pause"></i> アニメーション停止';
                    isAnimating = true;
                } else {
                    mapRenderer.stopAnimation();
                    this.innerHTML = '<i class="fas fa-play"></i> アニメーション開始';
                    isAnimating = false;
                }
            });
            
            // 時代設定
            yearSelect.addEventListener('input', function() {
                const year = parseInt(this.value);
                let era = "平安時代";
                if (year < 794) era = "奈良時代";
                else if (year < 1185) era = "平安時代";
                else era = "鎌倉時代";
                
                yearValue.textContent = `${year}年`;
                eraDisplay.textContent = `${era} (西暦${year}年)`;
            });
            
            // 気温・湿度・ENSO
            tempSlider.addEventListener('input', function() {
                currentTemperature = parseFloat(this.value);
                tempValue.textContent = this.value;
            });
            
            humiditySlider.addEventListener('input', function() {
                currentHumidity = parseInt(this.value);
                humidityValue.textContent = this.value;
            });
            
            ensoSlider.addEventListener('input', function() {
                currentENSO = parseFloat(this.value);
                ensoValue.textContent = this.value;
            });
            
            // 初期描画
            mapRenderer.render();
            
            console.log('気圧操作システムが起動しました');
            console.log('操作方法:');
            console.log('- 地図をクリック: 気圧を追加');
            console.log('- 気圧をドラッグ: 位置を移動');
            console.log('- 気圧をダブルクリック: 選択して編集');
            console.log('- Deleteキー: 選択中の気圧を削除');
        });
    </script>
</body>
</html>
