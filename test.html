<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>平安時代気象再現システム - バグ修正版</title>
    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --accent-color: #536dfe;
            --low-pressure-color: #CC0000;
            --high-pressure-color: #0066CC;
            --warning-color: #ff6b6b;
            --success-color: #4caf50;
            --text-primary: #333;
            --text-secondary: #666;
            --bg-primary: #f5f7ff;
            --bg-secondary: #e8eaf6;
            --bg-card: #ffffff;
            --equation-bg: #f8f9fa;
            --equation-border: #dee2e6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', 'Hiragino Kaku Gothic Pro', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 2000px;
            margin: 0 auto;
        }
        
        /* ヘッダー */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(26, 35, 126, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* メインコンテンツ */
        .main-grid {
            display: grid;
            grid-template-columns: 450px 1fr 450px;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 1800px) {
            .main-grid {
                grid-template-columns: 400px 1fr 400px;
            }
        }
        
        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 350px 1fr;
            }
        }
        
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* コントロールパネル */
        .control-panel {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            height: fit-content;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bg-secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 数式表示パネル */
        .equations-panel {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            height: fit-content;
            overflow-y: auto;
            max-height: 900px;
        }
        
        .equation-category {
            background: var(--equation-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-color);
        }
        
        .equation-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .equation-display {
            background: white;
            border: 1px solid var(--equation-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Times New Roman', serif;
            position: relative;
            overflow: hidden;
        }
        
        .equation-latex {
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 10px;
            color: #1a237e;
            font-weight: bold;
        }
        
        .equation-explanation {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .equation-values {
            background: var(--equation-bg);
            border-radius: 5px;
            padding: 10px;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .value-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .value-label {
            color: var(--text-secondary);
        }
        
        .value-number {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .equation-impact {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 8px;
            background: rgba(83, 109, 254, 0.1);
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .impact-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        /* 基本設定 */
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        select, input[type="range"], input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(83, 109, 254, 0.1);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider-value {
            min-width: 50px;
            text-align: center;
            color: var(--accent-color);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        /* 物理モデルパラメータ表示 */
        .physics-params {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .param-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .param-label {
            color: var(--text-secondary);
        }
        
        .param-value {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* 気圧操作パネル */
        .pressure-edit-panel {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            height: fit-content;
        }
        
        .pressure-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .pressure-type-btn {
            padding: 15px;
            border: 2px solid var(--bg-secondary);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
        }
        
        .pressure-type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .pressure-type-btn.active {
            color: white;
        }
        
        .pressure-type-btn.high {
            border-color: var(--high-pressure-color);
        }
        
        .pressure-type-btn.high.active {
            background: var(--high-pressure-color);
        }
        
        .pressure-type-btn.low {
            border-color: var(--low-pressure-color);
        }
        
        .pressure-type-btn.low.active {
            background: var(--low-pressure-color);
        }
        
        /* マップコンテナ */
        .map-container {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            min-height: 800px;
        }
        
        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bg-secondary);
        }
        
        .era-display {
            font-size: 1.8rem;
            color: var(--primary-color);
            font-weight: 700;
        }
        
        #weatherCanvas {
            width: 100%;
            height: 700px;
            border-radius: 10px;
            border: 2px solid var(--bg-secondary);
            background: #e8f4f8;
            display: block;
            cursor: crosshair;
            touch-action: none;
        }
        
        /* ボタン */
        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), #3d5afe);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(83, 109, 254, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #43a047);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #ff5252);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.3);
        }
        
        /* 凡例 */
        .legend {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        /* 操作ヒント */
        .operation-hint {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .hint-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .hint-list {
            list-style: none;
            padding-left: 5px;
        }
        
        .hint-list li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        
        .hint-list li:before {
            content: "•";
            color: var(--accent-color);
            font-weight: bold;
            position: absolute;
            left: 0;
        }
        
        /* ローディング表示 */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 15px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* エラーメッセージ */
        .error-message {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            color: #c62828;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="header">
            <h1>平安時代気象再現システム - バグ修正版</h1>
            <p class="subtitle">日本地図表示 × 気圧配置機能 × 物理モデル完全動作</p>
        </header>
        
        <!-- メインコンテンツ -->
        <div class="main-grid">
            <!-- 左側: 基本設定パネル -->
            <div class="control-panel">
                <!-- 時代選択 -->
                <div class="section-title">
                    <i class="fas fa-history"></i>
                    時代設定
                </div>
                
                <div class="input-group">
                    <label for="yearSelect">西暦指定 (794-1185)</label>
                    <div class="slider-container">
                        <input type="range" id="yearSelect" min="794" max="1185" value="1000" step="1">
                        <span class="slider-value" id="yearValue">1000年</span>
                    </div>
                </div>
                
                <!-- 物理モデルパラメータ -->
                <div class="section-title">
                    <i class="fas fa-calculator"></i>
                    物理モデルパラメータ
                </div>
                
                <div class="input-group">
                    <label for="temperature">平均気温: <span id="tempValue">24.5</span>°C</label>
                    <input type="range" id="temperature" min="20" max="30" value="24.5" step="0.1">
                </div>
                
                <div class="input-group">
                    <label for="humidity">湿度: <span id="humidityValue">60</span>%</label>
                    <input type="range" id="humidity" min="30" max="100" value="60" step="1">
                </div>
                
                <div class="input-group">
                    <label for="enso">ENSO指数: <span id="ensoValue">0.0</span></label>
                    <input type="range" id="enso" min="-2" max="2" value="0" step="0.1">
                </div>
                
                <div class="input-group">
                    <label for="albedo">アルベド（反射率）: <span id="albedoValue">0.3</span></label>
                    <input type="range" id="albedo" min="0.2" max="0.4" value="0.3" step="0.01">
                </div>
                
                <!-- 物理モデル計算結果 -->
                <div class="physics-params" id="physicsParams">
                    <div class="param-row">
                        <span class="param-label">放射平衡温度:</span>
                        <span class="param-value" id="radiativeTemp">15.2°C</span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">飽和水蒸気圧:</span>
                        <span class="param-value" id="saturationVapor">3.12 kPa</span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">気圧減率（標高100m）:</span>
                        <span class="param-value" id="pressureLapse">-11.4 hPa</span>
                    </div>
                    <div class="param-row">
                        <span class="param-label">大気安定度:</span>
                        <span class="param-value" id="stability">安定</span>
                    </div>
                </div>
                
                <!-- 日本地図操作 -->
                <div class="section-title">
                    <i class="fas fa-map"></i>
                    日本地図操作
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" id="loadJapanMapBtn">
                        <i class="fas fa-map-marked-alt"></i>
                        日本地図を表示
                    </button>
                    <button class="btn btn-primary" id="testMapBtn">
                        <i class="fas fa-check-circle"></i>
                        地図テスト
                    </button>
                </div>
                
                <!-- 操作ボタン -->
                <div class="section-title">
                    <i class="fas fa-cogs"></i>
                    気圧システム操作
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" id="addPressureBtn">
                        <i class="fas fa-plus-circle"></i>
                        気圧を追加
                    </button>
                    <button class="btn btn-primary" id="generateWindBtn">
                        <i class="fas fa-wind"></i>
                        風場を生成
                    </button>
                    <button class="btn btn-primary" id="calculatePhysicsBtn">
                        <i class="fas fa-calculator"></i>
                        物理計算
                    </button>
                    <button class="btn btn-warning" id="clearMapBtn">
                        <i class="fas fa-eraser"></i>
                        地図をクリア
                    </button>
                </div>
                
                <!-- 操作ヒント -->
                <div class="operation-hint">
                    <div class="hint-title">
                        <i class="fas fa-lightbulb"></i>
                        操作ガイド
                    </div>
                    <ul class="hint-list">
                        <li><strong>地図をクリック</strong>：気圧を配置（赤=低気圧, 青=高気圧）</li>
                        <li><strong>気圧をドラッグ</strong>：気圧中心を移動</li>
                        <li><strong>ダブルクリック</strong>：気圧を選択</li>
                        <li><strong>Deleteキー</strong>：選択中の気圧を削除</li>
                        <li><strong>先に「日本地図を表示」をクリック</strong></li>
                    </ul>
                </div>
                
                <!-- ステータス表示 -->
                <div id="statusDisplay" class="operation-hint" style="background: #e3f2fd; border-color: #bbdefb;">
                    <div class="hint-title">
                        <i class="fas fa-info-circle"></i>
                        システムステータス
                    </div>
                    <div id="mapStatus">地図: 未読み込み</div>
                    <div id="pressureStatus">気圧システム: 0個</div>
                    <div id="physicsStatus">物理モデル: 準備完了</div>
                </div>
            </div>
            
            <!-- 中央: 地図表示 -->
            <div class="map-container">
                <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                    <div class="spinner"></div>
                    <div id="loadingText">読み込み中...</div>
                </div>
                
                <div class="map-header">
                    <div class="era-display" id="eraDisplay">平安中期 (西暦1000年)</div>
                    <div>
                        <div id="weatherDisplay">操作モード: 気圧配置</div>
                        <div id="locationDisplay">クリックで気圧を配置</div>
                    </div>
                </div>
                
                <canvas id="weatherCanvas"></canvas>
                
                <!-- 凡例 -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #0066CC;"></div>
                        <span>高気圧 (ドラッグ可)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #CC0000;"></div>
                        <span>低気圧 (ドラッグ可)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #009900;"></div>
                        <span>等圧線</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF9900;"></div>
                        <span>風向・風速</span>
                    </div>
                </div>
                
                <!-- 現在計算中の数式 -->
                <div style="margin-top: 20px; padding: 15px; background: var(--equation-bg); border-radius: 10px;">
                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 10px;">
                        <i class="fas fa-calculator"></i> 現在計算中の数式:
                    </div>
                    <div id="currentEquation" style="font-family: 'Times New Roman', serif; font-size: 1.1rem; color: #1a237e;">
                        計算待機中...
                    </div>
                </div>
            </div>
            
            <!-- 右側: 数式表示パネル -->
            <div class="equations-panel" id="equationsPanel">
                <div class="section-title">
                    <i class="fas fa-square-root-alt"></i>
                    物理数式と計算値
                </div>
                
                <!-- 数式の内容は簡略化のため省略 -->
                <div class="equation-category">
                    <div class="equation-title">
                        <i class="fas fa-sun"></i>
                        放射・気温系
                    </div>
                    
                    <div class="equation-display">
                        <div class="equation-latex">(1−α)S/4 = σT⁴</div>
                        <div class="equation-explanation">
                            放射平衡温度：地球の出入りする放射エネルギーが平衡する温度
                        </div>
                        <div class="equation-values">
                            <div class="value-row">
                                <span class="value-label">計算温度:</span>
                                <span class="value-number" id="eq1_T">15.2 °C</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="equation-category">
                    <div class="equation-title">
                        <i class="fas fa-wind"></i>
                        風の公式
                    </div>
                    
                    <div class="equation-display">
                        <div class="equation-latex">f v = (1/ρ) ∂p/∂x</div>
                        <div class="equation-explanation">
                            地衡風：気圧勾配力とコリオリ力のバランスによる風
                        </div>
                        <div class="equation-values">
                            <div class="value-row">
                                <span class="value-label">計算風速:</span>
                                <span class="value-number" id="eq6_v">0.0 m/s</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- スクリプト -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        // ==================== 1. 物理モデル計算クラス ====================
        class PhysicsModel {
            constructor() {
                this.constants = {
                    solarConstant: 1361,
                    stefanBoltzmann: 5.67e-8,
                    earthAlbedo: 0.3,
                    gasConstant: 287.05,
                    gravity: 9.80665,
                    omega: 7.2921e-5,
                    specificHeat: 1005,
                    scaleHeight: 8400,
                    lapseRate: 6.5,
                    adiabaticLapseRate: 9.8,
                    lambda: 0.8
                };
            }
            
            radiativeEquilibriumTemperature(albedo) {
                const { solarConstant, stefanBoltzmann } = this.constants;
                const T_kelvin = Math.pow((1 - albedo) * solarConstant / (4 * stefanBoltzmann), 0.25);
                return T_kelvin - 273.15;
            }
            
            temperatureChangeFromForcing(deltaForcing) {
                return this.constants.lambda * deltaForcing;
            }
            
            coriolisParameter(lat) {
                return 2 * this.constants.omega * Math.sin(lat * Math.PI / 180);
            }
            
            geostrophicWind(pressureGradient, density, lat) {
                const f = this.coriolisParameter(lat);
                return pressureGradient / (density * f + 1e-10);
            }
            
            saturationVaporPressure(T) {
                return 6.11 * Math.exp(17.27 * T / (T + 237.3));
            }
        }
        
        // ==================== 2. 気圧システム管理クラス ====================
        class PressureSystemManager {
            constructor(physicsModel) {
                this.systems = [];
                this.selectedSystemId = null;
                this.nextId = 1;
                this.draggingSystemId = null;
                this.dragStartPos = null;
                this.physicsModel = physicsModel;
                this.updateStatus();
            }
            
            addSystem(type, lat, lon, name = null) {
                const id = this.nextId++;
                const defaultValues = type === 'high' ? {
                    name: name || `高気圧${id}`,
                    type: 'high',
                    pressure: 1020 + Math.random() * 10,
                    lat: lat,
                    lon: lon,
                    size: 200 + Math.random() * 100,
                    strength: 1.0 + Math.random(),
                    movement: { speed: 10, direction: 240 },
                    precipitation: 0
                } : {
                    name: name || `低気圧${id}`,
                    type: 'low',
                    pressure: 1000 - Math.random() * 10,
                    lat: lat,
                    lon: lon,
                    size: 150 + Math.random() * 100,
                    strength: 1.5 + Math.random(),
                    movement: { speed: 25, direction: 60 },
                    precipitation: 5 + Math.random() * 15
                };
                
                const system = {
                    id: id,
                    ...defaultValues,
                    timestamp: new Date().toISOString()
                };
                
                this.systems.push(system);
                this.selectedSystemId = id;
                this.updateStatus();
                
                console.log(`気圧システム追加: ${system.name} (${system.type})`, system);
                return system;
            }
            
            removeSystem(id) {
                const index = this.systems.findIndex(s => s.id === id);
                if (index !== -1) {
                    const removed = this.systems.splice(index, 1)[0];
                    if (this.selectedSystemId === id) {
                        this.selectedSystemId = null;
                    }
                    this.updateStatus();
                    console.log(`気圧システム削除: ${removed.name}`);
                    return true;
                }
                return false;
            }
            
            clearAll() {
                console.log(`全気圧システム削除: ${this.systems.length}個`);
                this.systems = [];
                this.selectedSystemId = null;
                this.updateStatus();
            }
            
            getSystem(id) {
                return this.systems.find(s => s.id === id);
            }
            
            startDrag(systemId, startX, startY) {
                const system = this.getSystem(systemId);
                if (system) {
                    this.draggingSystemId = systemId;
                    this.dragStartPos = { lat: system.lat, lon: system.lon, x: startX, y: startY };
                    return true;
                }
                return false;
            }
            
            updateDrag(mouseX, mouseY) {
                if (!this.draggingSystemId || !this.dragStartPos) return null;
                
                const system = this.getSystem(this.draggingSystemId);
                if (!system) return null;
                
                // 座標変換（簡易版）
                const latDelta = (mouseY - this.dragStartPos.y) * -0.1;
                const lonDelta = (mouseX - this.dragStartPos.x) * 0.1;
                
                system.lat = Math.max(30, Math.min(45, this.dragStartPos.lat + latDelta));
                system.lon = Math.max(125, Math.min(145, this.dragStartPos.lon + lonDelta));
                
                this.updateStatus();
                return system;
            }
            
            endDrag() {
                this.draggingSystemId = null;
                this.dragStartPos = null;
            }
            
            updateStatus() {
                document.getElementById('pressureStatus').textContent = 
                    `気圧システム: ${this.systems.length}個`;
            }
            
            generateIsobars() {
                const isobars = [];
                const interval = 4;
                
                this.systems.forEach(system => {
                    const type = system.type;
                    const basePressure = system.pressure;
                    const radius = system.size;
                    
                    for (let p = Math.floor(basePressure); 
                         type === 'high' ? p >= Math.floor(basePressure) - 20 : p <= Math.floor(basePressure) + 20; 
                         type === 'high' ? p -= interval : p += interval) {
                        
                        if (p % interval === 0) {
                            const pressureDiff = Math.abs(basePressure - p);
                            const isobarRadius = radius * (1 + pressureDiff / 5);
                            
                            isobars.push({
                                pressure: p,
                                center: { lat: system.lat, lon: system.lon },
                                radius: isobarRadius,
                                type: type
                            });
                        }
                    }
                });
                
                return isobars;
            }
            
            calculateWindField() {
                const windField = [];
                const gridSize = 2;
                const currentTemp = parseFloat(document.getElementById('temperature').value);
                
                for (let lat = 30; lat <= 45; lat += gridSize) {
                    for (let lon = 125; lon <= 145; lon += gridSize) {
                        let pressureGradientX = 0;
                        let pressureGradientY = 0;
                        
                        this.systems.forEach(system => {
                            const dx = (lon - system.lon) * 111.32 * Math.cos(lat * Math.PI / 180);
                            const dy = (lat - system.lat) * 111.32;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < system.size) {
                                const influence = (system.size - distance) / system.size;
                                const gradient = system.strength * influence;
                                
                                if (system.type === 'high') {
                                    pressureGradientX -= gradient * (lon - system.lon) / (distance + 0.001);
                                    pressureGradientY -= gradient * (lat - system.lat) / (distance + 0.001);
                                } else {
                                    pressureGradientX += gradient * (lon - system.lon) / (distance + 0.001);
                                    pressureGradientY += gradient * (lat - system.lat) / (distance + 0.001);
                                }
                            }
                        });
                        
                        if (Math.abs(pressureGradientX) > 0.001 || Math.abs(pressureGradientY) > 0.001) {
                            const gradient = Math.sqrt(pressureGradientX * pressureGradientX + pressureGradientY * pressureGradientY);
                            const f = this.physicsModel.coriolisParameter(lat);
                            const density = 1.225; // 簡易化
                            const windSpeed = Math.abs(gradient) / (density * Math.abs(f) + 0.0001) * 0.1;
                            
                            let direction = Math.atan2(pressureGradientY, pressureGradientX) * 180 / Math.PI + 90;
                            if (direction < 0) direction += 360;
                            if (direction >= 360) direction -= 360;
                            
                            windField.push({
                                lat: lat,
                                lon: lon,
                                speed: Math.min(windSpeed, 50),
                                direction: direction
                            });
                        }
                    }
                }
                
                return windField;
            }
        }
        
        // ==================== 3. 天気図描画クラス ====================
        class WeatherMapRenderer {
            constructor(canvasId, pressureManager) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.pressureManager = pressureManager;
                
                this.width = this.canvas.width = this.canvas.parentElement.clientWidth;
                this.height = this.canvas.height = 700;
                
                this.japanMapImage = null;
                this.mapLoaded = false;
                this.isInitialized = false;
                
                this.setupEventListeners();
                this.drawBackground();
            }
            
            setupEventListeners() {
                // キャンバスクリックで気圧追加
                this.canvas.addEventListener('click', (e) => {
                    if (!this.mapLoaded) {
                        alert('先に「日本地図を表示」ボタンをクリックしてください');
                        return;
                    }
                    
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const latLon = this.canvasToLatLon(x, y);
                    
                    // 気圧タイプを取得
                    const pressureType = document.querySelector('.pressure-type-btn.active')?.dataset.type || 'high';
                    
                    // 新しい気圧を追加
                    this.pressureManager.addSystem(pressureType, latLon.lat, latLon.lon);
                    
                    // 再描画
                    this.render();
                    
                    document.getElementById('locationDisplay').textContent = 
                        `気圧配置: ${latLon.lat.toFixed(2)}°N, ${latLon.lon.toFixed(2)}°E`;
                });
                
                // ダブルクリックで気圧選択
                this.canvas.addEventListener('dblclick', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const clickedSystem = this.findSystemAtPosition(x, y);
                    if (clickedSystem) {
                        document.getElementById('locationDisplay').textContent = 
                            `選択: ${clickedSystem.name} (${clickedSystem.type === 'high' ? '高気圧' : '低気圧'})`;
                    }
                });
                
                // ドラッグ開始
                this.canvas.addEventListener('mousedown', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const clickedSystem = this.findSystemAtPosition(x, y);
                    if (clickedSystem) {
                        this.pressureManager.startDrag(clickedSystem.id, x, y);
                        this.canvas.style.cursor = 'grabbing';
                        document.getElementById('weatherDisplay').textContent = 'ドラッグモード: 気圧移動中';
                    }
                });
                
                // ドラッグ中
                this.canvas.addEventListener('mousemove', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    if (this.pressureManager.draggingSystemId) {
                        this.pressureManager.updateDrag(x, y);
                        this.render();
                    } else {
                        const system = this.findSystemAtPosition(x, y);
                        this.canvas.style.cursor = system ? 'grab' : 'crosshair';
                    }
                });
                
                // ドラッグ終了
                this.canvas.addEventListener('mouseup', () => {
                    if (this.pressureManager.draggingSystemId) {
                        this.pressureManager.endDrag();
                        this.canvas.style.cursor = 'crosshair';
                        document.getElementById('weatherDisplay').textContent = '操作モード: 気圧配置';
                    }
                });
                
                // Deleteキーで削除
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Delete' && this.pressureManager.selectedSystemId) {
                        this.pressureManager.removeSystem(this.pressureManager.selectedSystemId);
                        this.render();
                    }
                });
                
                // ウィンドウリサイズ
                window.addEventListener('resize', () => {
                    this.width = this.canvas.width = this.canvas.parentElement.clientWidth;
                    this.height = this.canvas.height = 700;
                    this.render();
                });
            }
            
            canvasToLatLon(x, y) {
                const lat = 45 - (y / this.height) * (45 - 30);
                const lon = 125 + (x / this.width) * (145 - 125);
                return { 
                    lat: Math.max(30, Math.min(45, lat)), 
                    lon: Math.max(125, Math.min(145, lon)) 
                };
            }
            
            latLonToCanvas(lat, lon) {
                const x = ((lon - 125) / (145 - 125)) * this.width;
                const y = this.height - ((lat - 30) / (45 - 30)) * this.height;
                return { x, y };
            }
            
            findSystemAtPosition(x, y) {
                const latLon = this.canvasToLatLon(x, y);
                
                for (const system of this.pressureManager.systems) {
                    const pos = this.latLonToCanvas(system.lat, system.lon);
                    const distance = Math.sqrt(Math.pow(pos.x - x, 2) + Math.pow(pos.y - y, 2));
                    
                    if (distance < 20) {
                        return system;
                    }
                }
                return null;
            }
            
            async loadJapanMap() {
                return new Promise((resolve, reject) => {
                    this.japanMapImage = new Image();
                    this.japanMapImage.crossOrigin = "anonymous";
                    
                    // 日本地図のSVG画像（パブリックドメイン）
                    this.japanMapImage.src = 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Japan_blank_map.svg/800px-Japan_blank_map.svg.png';
                    
                    this.japanMapImage.onload = () => {
                        this.mapLoaded = true;
                        this.render();
                        document.getElementById('mapStatus').textContent = '地図: 読み込み完了';
                        console.log('日本地図の読み込み成功');
                        resolve();
                    };
                    
                    this.japanMapImage.onerror = () => {
                        console.warn('日本地図画像の読み込みに失敗しました。代替のシルエットを使用します。');
                        this.mapLoaded = false;
                        this.render();
                        resolve();
                    };
                });
            }
            
            drawBackground() {
                // 背景グラデーション
                const gradient = this.ctx.createLinearGradient(0, 0, this.width, this.height);
                gradient.addColorStop(0, '#e8f4f8');
                gradient.addColorStop(1, '#cce7ff');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.width, this.height);
                
                // グリッド線
                this.ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                this.ctx.lineWidth = 1;
                
                // 経度線
                for (let lon = 125; lon <= 145; lon += 5) {
                    const pos = this.latLonToCanvas(30, lon);
                    this.ctx.beginPath();
                    this.ctx.moveTo(pos.x, 0);
                    this.ctx.lineTo(pos.x, this.height);
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = '#333';
                    this.ctx.font = '12px Arial';
                    this.ctx.fillText(`${lon}°E`, pos.x + 5, 20);
                }
                
                // 緯度線
                for (let lat = 30; lat <= 45; lat += 5) {
                    const pos = this.latLonToCanvas(lat, 125);
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, pos.y);
                    this.ctx.lineTo(this.width, pos.y);
                    this.ctx.stroke();
                    
                    this.ctx.fillText(`${lat}°N`, 10, pos.y - 5);
                }
            }
            
            drawJapanMap() {
                if (this.mapLoaded && this.japanMapImage) {
                    // 日本地図の描画（適切なスケーリング）
                    const mapWidth = this.width * 0.8;
                    const mapHeight = this.height * 0.7;
                    const mapX = (this.width - mapWidth) / 2;
                    const mapY = (this.height - mapHeight) / 2;
                    
                    this.ctx.drawImage(this.japanMapImage, mapX, mapY, mapWidth, mapHeight);
                    
                    // 半透明のオーバーレイ
                    this.ctx.fillStyle = 'rgba(144, 238, 144, 0.2)';
                    this.ctx.fillRect(mapX, mapY, mapWidth, mapHeight);
                } else {
                    // シルエットフォールバック
                    this.drawJapanSilhouette();
                }
            }
            
            drawJapanSilhouette() {
                this.ctx.fillStyle = 'rgba(144, 238, 144, 0.4)';
                this.ctx.strokeStyle = '#2E8B57';
                this.ctx.lineWidth = 2;
                
                // 本州の簡易シルエット
                this.ctx.beginPath();
                const points = [
                    this.latLonToCanvas(41.5, 140.0),
                    this.latLonToCanvas(40.5, 141.5),
                    this.latLonToCanvas(39.0, 141.5),
                    this.latLonToCanvas(37.0, 140.5),
                    this.latLonToCanvas(35.0, 139.0),
                    this.latLonToCanvas(34.0, 136.0),
                    this.latLonToCanvas(33.0, 132.0),
                    this.latLonToCanvas(34.5, 131.0),
                    this.latLonToCanvas(35.5, 133.0),
                    this.latLonToCanvas(36.5, 135.0),
                    this.latLonToCanvas(38.0, 137.0),
                    this.latLonToCanvas(39.5, 139.5),
                    this.latLonToCanvas(41.5, 140.0)
                ];
                
                if (points.length > 0) {
                    this.ctx.moveTo(points[0].x, points[0].y);
                    for (let i = 1; i < points.length; i++) {
                        this.ctx.lineTo(points[i].x, points[i].y);
                    }
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.stroke();
                }
            }
            
            drawIsobars(isobars) {
                isobars.forEach(isobar => {
                    const pos = this.latLonToCanvas(isobar.center.lat, isobar.center.lon);
                    const radius = isobar.radius * (this.width / (145 - 125)) / 111.32;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
                    this.ctx.strokeStyle = isobar.type === 'high' ? 
                        'rgba(0, 102, 204, 0.7)' : 'rgba(204, 0, 0, 0.7)';
                    this.ctx.lineWidth = 1.5;
                    this.ctx.setLineDash([5, 3]);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                });
            }
            
            drawPressureCenters(systems) {
                systems.forEach(system => {
                    const pos = this.latLonToCanvas(system.lat, system.lon);
                    const isSelected = system.id === this.pressureManager.selectedSystemId;
                    const isDragging = system.id === this.pressureManager.draggingSystemId;
                    
                    // サイズに基づく円
                    const sizeRadius = system.size * (this.width / (145 - 125)) / 111.32 / 5;
                    this.ctx.beginPath();
                    this.ctx.arc(pos.x, pos.y, sizeRadius, 0, Math.PI * 2);
                    this.ctx.fillStyle = system.type === 'high' ? 
                        'rgba(0, 102, 204, 0.1)' : 'rgba(204, 0, 0, 0.1)';
                    this.ctx.fill();
                    this.ctx.strokeStyle = system.type === 'high' ? 
                        'rgba(0, 102, 204, 0.3)' : 'rgba(204, 0, 0, 0.3)';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                    
                    // 中心点
                    this.ctx.beginPath();
                    this.ctx.arc(pos.x, pos.y, isSelected ? 16 : 12, 0, Math.PI * 2);
                    this.ctx.fillStyle = system.type === 'high' ? '#0066CC' : '#CC0000';
                    this.ctx.fill();
                    this.ctx.strokeStyle = isSelected ? '#FFD700' : '#FFFFFF';
                    this.ctx.lineWidth = isSelected ? 4 : 3;
                    this.ctx.stroke();
                    
                    // 「高」「低」ラベル
                    this.ctx.fillStyle = '#FFFFFF';
                    this.ctx.font = isSelected ? 'bold 14px Arial' : 'bold 12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(system.type === 'high' ? '高' : '低', pos.x, pos.y);
                    
                    // 気圧値
                    this.ctx.fillStyle = system.type === 'high' ? '#0066CC' : '#CC0000';
                    this.ctx.font = 'bold 14px Arial';
                    this.ctx.fillText(`${system.pressure.toFixed(0)} hPa`, pos.x, pos.y - 25);
                });
            }
            
            drawWindField(windField) {
                windField.forEach(wind => {
                    const pos = this.latLonToCanvas(wind.lat, wind.lon);
                    
                    if (wind.speed < 1) return;
                    
                    const length = Math.min(wind.speed * 2, 40);
                    const angle = (wind.direction - 90) * Math.PI / 180;
                    
                    // 矢印の線
                    this.ctx.beginPath();
                    this.ctx.moveTo(pos.x, pos.y);
                    this.ctx.lineTo(
                        pos.x + length * Math.cos(angle),
                        pos.y + length * Math.sin(angle)
                    );
                    this.ctx.strokeStyle = wind.speed > 20 ? '#FF3300' : 
                                          wind.speed > 10 ? '#FF9900' : '#333';
                    this.ctx.lineWidth = Math.min(wind.speed / 10, 3);
                    this.ctx.stroke();
                });
            }
            
            render() {
                // キャンバスをクリア
                this.ctx.clearRect(0, 0, this.width, this.height);
                
                // 背景を描画
                this.drawBackground();
                
                // 日本地図を描画
                this.drawJapanMap();
                
                // 気圧システムがなければ基本表示
                if (this.pressureManager.systems.length === 0) {
                    if (this.mapLoaded) {
                        this.ctx.fillStyle = '#666';
                        this.ctx.font = '20px Arial';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText('日本地図をクリックして気圧を配置してください', 
                                         this.width/2, this.height/2);
                    }
                    return;
                }
                
                // 等圧線を描画
                const isobars = this.pressureManager.generateIsobars();
                this.drawIsobars(isobars);
                
                // 風場を描画
                const windField = this.pressureManager.calculateWindField();
                this.drawWindField(windField);
                
                // 気圧中心を描画
                this.drawPressureCenters(this.pressureManager.systems);
                
                // タイトル
                this.ctx.fillStyle = '#1a237e';
                this.ctx.font = 'bold 24px Arial';
                this.ctx.textAlign = 'left';
                this.ctx.fillText('平安時代天気図 - 気圧操作モード', 20, 40);
            }
        }
        
        // ==================== 4. アプリケーション初期化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            // 物理モデルの初期化
            const physicsModel = new PhysicsModel();
            
            // 気圧マネージャーの初期化
            const pressureManager = new PressureSystemManager(physicsModel);
            
            // 天気図レンダラーの初期化
            let mapRenderer;
            
            // ローディング表示
            function showLoading(show, text = '読み込み中...') {
                const overlay = document.getElementById('loadingOverlay');
                const loadingText = document.getElementById('loadingText');
                loadingText.textContent = text;
                overlay.style.display = show ? 'flex' : 'none';
            }
            
            // 日本地図読み込みボタン
            document.getElementById('loadJapanMapBtn').addEventListener('click', async function() {
                showLoading(true, '日本地図を読み込み中...');
                
                try {
                    if (!mapRenderer) {
                        mapRenderer = new WeatherMapRenderer('weatherCanvas', pressureManager);
                    }
                    
                    await mapRenderer.loadJapanMap();
                    
                    document.getElementById('mapStatus').textContent = '地図: 表示中';
                    document.getElementById('weatherDisplay').textContent = '操作モード: 気圧配置';
                    
                    setTimeout(() => {
                        showLoading(false);
                        alert('日本地図を表示しました！\n地図をクリックして気圧を配置してください。');
                    }, 500);
                } catch (error) {
                    console.error('地図読み込みエラー:', error);
                    showLoading(false);
                    alert('地図の読み込みに失敗しました。シルエット表示に切り替えます。');
                }
            });
            
            // 地図テストボタン
            document.getElementById('testMapBtn').addEventListener('click', function() {
                if (!mapRenderer) {
                    mapRenderer = new WeatherMapRenderer('weatherCanvas', pressureManager);
                }
                
                // テスト用に気圧を追加
                pressureManager.addSystem('high', 35.0, 135.0, "テスト高気圧");
                pressureManager.addSystem('low', 34.0, 136.0, "テスト低気圧");
                
                if (mapRenderer.mapLoaded) {
                    mapRenderer.render();
                    alert('地図テスト完了：2つのテスト気圧を追加しました');
                } else {
                    alert('地図がまだ読み込まれていません。「日本地図を表示」を先にクリックしてください');
                }
            });
            
            // 気圧追加ボタン
            document.getElementById('addPressureBtn').addEventListener('click', function() {
                if (!mapRenderer || !mapRenderer.mapLoaded) {
                    alert('先に「日本地図を表示」ボタンをクリックしてください');
                    return;
                }
                
                const type = document.querySelector('.pressure-type-btn.active')?.dataset.type || 'high';
                const lat = 35.0 + (Math.random() - 0.5) * 2;
                const lon = 135.0 + (Math.random() - 0.5) * 2;
                
                pressureManager.addSystem(type, lat, lon);
                mapRenderer.render();
                
                alert(`${type === 'high' ? '高気圧' : '低気圧'}を追加しました`);
            });
            
            // 風場生成ボタン
            document.getElementById('generateWindBtn').addEventListener('click', function() {
                if (!mapRenderer) {
                    alert('先に地図を読み込んでください');
                    return;
                }
                
                mapRenderer.render();
                alert('気圧配置に基づいて風場を計算しました');
            });
            
            // 物理計算ボタン
            document.getElementById('calculatePhysicsBtn').addEventListener('click', function() {
                const temp = parseFloat(document.getElementById('temperature').value);
                const albedo = parseFloat(document.getElementById('albedo').value);
                
                // 放射平衡温度計算
                const radiativeTemp = physicsModel.radiativeEquilibriumTemperature(albedo);
                document.getElementById('radiativeTemp').textContent = `${radiativeTemp.toFixed(1)}°C`;
                document.getElementById('eq1_T').textContent = `${radiativeTemp.toFixed(1)} °C`;
                
                // 地衡風計算（デモ）
                const windSpeed = physicsModel.geostrophicWind(1.5, 1.225, 35.0);
                document.getElementById('eq6_v').textContent = `${windSpeed.toFixed(1)} m/s`;
                
                alert(`物理計算完了\n放射平衡温度: ${radiativeTemp.toFixed(1)}°C\n推定風速: ${windSpeed.toFixed(1)} m/s`);
            });
            
            // 地図クリアボタン
            document.getElementById('clearMapBtn').addEventListener('click', function() {
                if (confirm('全ての気圧システムを削除しますか？')) {
                    pressureManager.clearAll();
                    if (mapRenderer) {
                        mapRenderer.render();
                    }
                    alert('地図上の気圧システムを全て削除しました');
                }
            });
            
            // 気圧タイプ選択ボタン
            document.querySelectorAll('.pressure-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.pressure-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // 初期設定
            const tempSlider = document.getElementById('temperature');
            const tempValue = document.getElementById('tempValue');
            const humiditySlider = document.getElementById('humidity');
            const humidityValue = document.getElementById('humidityValue');
            const ensoSlider = document.getElementById('enso');
            const ensoValue = document.getElementById('ensoValue');
            const albedoSlider = document.getElementById('albedo');
            const albedoValue = document.getElementById('albedoValue');
            const yearSelect = document.getElementById('yearSelect');
            const yearValue = document.getElementById('yearValue');
            
            tempSlider.addEventListener('input', function() {
                tempValue.textContent = this.value;
            });
            
            humiditySlider.addEventListener('input', function() {
                humidityValue.textContent = this.value;
            });
            
            ensoSlider.addEventListener('input', function() {
                ensoValue.textContent = this.value;
            });
            
            albedoSlider.addEventListener('input', function() {
                albedoValue.textContent = parseFloat(this.value).toFixed(2);
            });
            
            yearSelect.addEventListener('input', function() {
                const year = parseInt(this.value);
                let era = "平安時代";
                if (year < 794) era = "奈良時代";
                else if (year < 1185) era = "平安時代";
                else era = "鎌倉時代";
                
                yearValue.textContent = `${year}年`;
                document.getElementById('eraDisplay').textContent = `${era} (西暦${year}年)`;
            });
            
            // デフォルトで気圧タイプ選択ボタンをアクティブにする
            document.querySelector('.pressure-type-btn.high').classList.add('active');
            
            console.log('システム初期化完了');
            console.log('操作手順:');
            console.log('1. 「日本地図を表示」ボタンをクリック');
            console.log('2. 地図上をクリックして気圧を配置');
            console.log('3. 気圧をドラッグして移動');
        });
    </script>
</body>
</html>
